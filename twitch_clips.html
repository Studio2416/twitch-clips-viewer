<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Clips</title>
    <style>
        body {
            background-color: #000;
            color: #fff;
            text-align: center;
            font-family: Arial, sans-serif;
        }
        #clip-title, #clip-creator {
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div id="clip-title"></div>
    <div id="clip-creator"></div>
    <div id="clip-container"></div>

    <script>
        const clientId = '6swpx9n7e3gotvrlxz4z9piyo6uf79';
        const clientSecret = 'zictk5ep2jtd5s0e14wrla256bhlf2';
        const username = 'fairy_julie'; // 配信者のユーザー名
        let accessToken = '';
        let broadcasterId = '';
        let clips = [];
        let currentClipIndex = -1;

        async function fetchAccessToken() {
            try {
                const response = await fetch('https://id.twitch.tv/oauth2/token', {
                    method: 'POST',
                    body: new URLSearchParams({
                        client_id: clientId,
                        client_secret: clientSecret,
                        grant_type: 'client_credentials'
                    })
                });
                const data = await response.json();
                accessToken = data.access_token;
            } catch (error) {
                console.error('Error fetching access token:', error);
            }
        }

        async function fetchUserId(username, accessToken) {
            try {
                const response = await fetch(`https://api.twitch.tv/helix/users?login=${username}`, {
                    headers: {
                        'Client-ID': clientId,
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const data = await response.json();
                return data.data[0].id;
            } catch (error) {
                console.error('Error fetching user ID:', error);
            }
        }

        async function fetchClips() {
            try {
                const response = await fetch(`https://api.twitch.tv/helix/clips?broadcaster_id=${broadcasterId}`, {
                    headers: {
                        'Client-ID': clientId,
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const data = await response.json();
                console.log('Fetched clips:', data.data);
                return data.data;
            } catch (error) {
                console.error('Error fetching clips:', error);
            }
        }

        function getRandomClipIndex() {
            return Math.floor(Math.random() * clips.length);
        }

        function displayClip(index) {
            const clip = clips[index];
            console.log('Displaying clip:', clip);
            if (!clip) {
                console.error('No clip found at index:', index);
                return;
            }
            document.getElementById('clip-title').innerText = clip.title;
            document.getElementById('clip-creator').innerText = `Created by: ${clip.creator_name}`;
            document.getElementById('clip-container').innerHTML = `
                <iframe 
                    src="https://clips.twitch.tv/embed?clip=${clip.id}&parent=localhost" 
                    frameborder="0" 
                    allowfullscreen="true" 
                    scrolling="no" 
                    height="400" 
                    width="600">
                </iframe>
            `;
        }

        async function init() {
            await fetchAccessToken();
            broadcasterId = await fetchUserId(username, accessToken);
            clips = await fetchClips();
            console.log('Clips array:', clips);
            if (clips.length > 0) {
                currentClipIndex = getRandomClipIndex();
                displayClip(currentClipIndex);
            } else {
                console.error('No clips found for the broadcaster.');
            }
        }

        init();
    </script>
</body>
</html>
