<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Twitch Clips Player</title>
    <style>
        body {
            background-color: #000;
            color: #fff;
            text-align: center;
            font-family: Arial, sans-serif;
        }
        #clip-title, #clip-creator {
            margin: 20px 0;
        }
        #video-container {
            width: 600px;
            height: 338px;
            margin: 0 auto;
            background-color: #000;
        }
        video {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="clip-title"></div>
    <div id="clip-creator"></div>
    <div id="video-container">
        <video id="video-player" controls autoplay></video>
    </div>

    <script>
        const clientId = '6swpx9n7e3gotvrlxz4z9piyo6uf79';
        const clientSecret = 'zictk5ep2jtd5s0e14wrla256bhlf2';
        const username = 'fairy_julie'; // 配信者のユーザー名
        let accessToken = '';
        let broadcasterId = '';
        let clips = [];
        let currentClipIndex = -1;
        let playedClips = []; // 再生済みのクリップのIDを保存するリスト

        async function fetchAccessToken() {
            try {
                const response = await fetch('https://id.twitch.tv/oauth2/token', {
                    method: 'POST',
                    body: new URLSearchParams({
                        client_id: clientId,
                        client_secret: clientSecret,
                        grant_type: 'client_credentials'
                    })
                });
                const data = await response.json();
                accessToken = data.access_token;
            } catch (error) {
                console.error('Error fetching access token:', error);
            }
        }

        async function fetchUserId(username, accessToken) {
            try {
                const response = await fetch(`https://api.twitch.tv/helix/users?login=${username}`, {
                    headers: {
                        'Client-ID': clientId,
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const data = await response.json();
                return data.data[0].id;
            } catch (error) {
                console.error('Error fetching user ID:', error);
            }
        }

        async function fetchClips() {
            try {
                const response = await fetch(`https://api.twitch.tv/helix/clips?broadcaster_id=${broadcasterId}`, {
                    headers: {
                        'Client-ID': clientId,
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const data = await response.json();
                console.log('Fetched clips:', data.data);
                return data.data;
            } catch (error) {
                console.error('Error fetching clips:', error);
            }
        }

        function getVideoUrl(thumbnailUrl) {
            // 例: "https://clips-media-assets2.twitch.tv/AT-cm%7C12345-preview-480x272.jpg"
            // このURLをビデオURLに変換
            return thumbnailUrl.replace('-preview-480x272.jpg', '.mp4');
        }

        function getRandomClipIndex() {
            // 再生していないクリップを見つける
            const unplayedClips = clips.filter(clip => !playedClips.includes(clip.id));
            
            // すべてのクリップが再生済みの場合、リセットする
            if (unplayedClips.length === 0) {
                playedClips = [];
                return Math.floor(Math.random() * clips.length);
            }

            // 未再生クリップの中からランダムに選択
            const randomIndex = Math.floor(Math.random() * unplayedClips.length);
            const selectedClip = unplayedClips[randomIndex];
            
            // 選択したクリップのインデックスを返す
            return clips.findIndex(clip => clip.id === selectedClip.id);
        }

        function displayClip(index) {
            const clip = clips[index];
            console.log('Displaying clip:', clip);
            if (!clip) {
                console.error('No clip found at index:', index);
                return;
            }
            
            // クリップを再生済みリストに追加
            if (!playedClips.includes(clip.id)) {
                playedClips.push(clip.id);
            }

            document.getElementById('clip-title').innerText = clip.title;
            document.getElementById('clip-creator').innerText = `Created by: ${clip.creator_name}`;
            const videoUrl = getVideoUrl(clip.thumbnail_url); // 動画URLを取得
            const videoPlayer = document.getElementById('video-player');
            videoPlayer.src = videoUrl;
            videoPlayer.play();

            // 次のクリップに自動で移動
            videoPlayer.onended = () => {
                currentClipIndex = getRandomClipIndex();
                displayClip(currentClipIndex);
            };
        }

        async function init() {
            await fetchAccessToken();
            broadcasterId = await fetchUserId(username, accessToken);
            clips = await fetchClips();
            console.log('Clips array:', clips);
            if (clips.length > 0) {
                currentClipIndex = getRandomClipIndex();
                displayClip(currentClipIndex);
            } else {
                console.error('No clips found for the broadcaster.');
            }
        }

        init();
    </script>
</body>
</html>
